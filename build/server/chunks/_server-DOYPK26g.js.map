{"version":3,"file":"_server-DOYPK26g.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/stripe-webhook/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport Stripe from \"stripe\";\nimport { A as AIAnalysisService, E as EmailService } from \"../../../../chunks/emailService.js\";\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY || \"sk_test_your_secret_key_here\", {\n  apiVersion: \"2023-10-16\"\n});\nconst endpointSecret = process.env.STRIPE_WEBHOOK_SECRET;\nasync function POST({ request }) {\n  const body = await request.text();\n  const sig = request.headers.get(\"stripe-signature\");\n  let event;\n  try {\n    event = stripe.webhooks.constructEvent(body, sig, endpointSecret);\n  } catch (err) {\n    console.error(\"‚ùå Webhook signature verification failed:\", err.message);\n    return json({ error: \"Webhook signature verification failed\" }, { status: 400 });\n  }\n  console.log(`üé£ Received Stripe webhook: ${event.type}`);\n  if (event.type === \"checkout.session.completed\") {\n    const session = event.data.object;\n    try {\n      console.log(`üí∞ Checkout completed: ${session.id} - $${session.amount_total / 100}`);\n      const {\n        serviceType,\n        customerEmail,\n        customerName,\n        customerPhone,\n        equipmentType,\n        make,\n        model,\n        year,\n        problemDescription,\n        errorCodes,\n        shopQuote,\n        timestamp\n      } = session.metadata;\n      const diagnosticRequest = {\n        selectedService: serviceType,\n        equipmentType: equipmentType || \"Equipment\",\n        make: make || \"Unknown Make\",\n        model: model || \"Unknown Model\",\n        year: year || null,\n        problemDescription: problemDescription || \"Customer paid for priority diagnostic service\",\n        errorCodes: errorCodes || null,\n        shopQuote: shopQuote || null,\n        fullName: customerName,\n        email: customerEmail,\n        phone: customerPhone || null,\n        sessionId: session.id,\n        amountPaid: session.amount_total / 100,\n        paymentStatus: \"PAID\"\n      };\n      let analysisResult;\n      if (serviceType === \"emergency\") {\n        analysisResult = await AIAnalysisService.performEmergencyTriage(diagnosticRequest);\n        console.log(\"‚ö° Emergency analysis completed for paid customer\");\n      } else {\n        analysisResult = await AIAnalysisService.analyzeDiagnosticRequest(diagnosticRequest);\n        console.log(\"üéØ Full diagnostic analysis completed for paid customer\");\n      }\n      const reportData = {\n        equipmentType: diagnosticRequest.equipmentType,\n        make: diagnosticRequest.make,\n        model: diagnosticRequest.model,\n        problemDescription: diagnosticRequest.problemDescription,\n        paymentStatus: \"PAID\",\n        paymentAmount: `$${diagnosticRequest.amountPaid}`,\n        serviceLevel: serviceType.toUpperCase(),\n        ...analysisResult\n      };\n      await EmailService.sendDiagnosticReport(\n        reportData,\n        customerEmail,\n        customerName,\n        \"jeremylongshore@gmail.com\"\n        // Always CC Jeremy for paid customers\n      );\n      console.log(`‚úÖ Premium diagnostic report sent to ${customerEmail}`);\n      await EmailService.notifyPaymentReceived({\n        paymentIntentId: session.id,\n        amount: session.amount_total / 100,\n        customerEmail,\n        customerName,\n        serviceType\n      });\n    } catch (error) {\n      console.error(\"‚ùå Failed to process paid diagnostic:\", error);\n    }\n  }\n  return json({ received: true });\n}\nexport {\n  POST\n};\n"],"names":["AIAnalysisService","EmailService"],"mappings":"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"}